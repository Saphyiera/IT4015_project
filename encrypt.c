#include <stdio.h>

unsigned int A[3] = {0,0,0},	//12 93/96
		 	 B[3] = {0,0,0},	//11 84/96
	     	 C[4] = {0,0,0,0},	//14 111/128
		 	 IV[3] = {0,0,0},	//10 80/80
		 	 Key[3] = {0,0,0}, 	//10 80/80
			 A_66 = 0, A_69 = 0, A_91 = 0, A_92 = 0, A_93 = 0,
	 		 B_69 = 0, B_78 = 0, B_82 = 0, B_83 = 0, B_84 = 0,
	 		 C_66 = 0, C_87 = 0, C_109= 0, C_110= 0, C_111= 0,
	 		 Out_A= 0, Out_B= 0, Out_C= 0, s = 0;
	 
void get_key(){
	FILE * f = fopen("key.txt" , "r");
	fscanf(f,"%u",Key);
	fscanf(f,"%u",Key + 1);
	fscanf(f,"%u",Key + 2);
	fclose(f);
}

void get_iv(){
	FILE * f = fopen("iv.txt" , "r");
	fscanf(f,"%u",IV);
	fscanf(f,"%u",IV + 1);
	fscanf(f,"%u",IV + 2);
	fclose(f);
}

void Initialize(){
	unsigned int temp = IV[2] << 16;
	int i = 0;
	A[0] = IV[0];
	A[1] = IV[1];
	A[2] = temp >> 16;
	B[0] = Key[0];
	B[1] = Key[1];
	temp = Key[2] << 16;
	B[2] = temp >> 16;
	C[3] = 7 << 13; 
//	printf("%u %u %u\n%u %u %u\n%u %u %u %u\n",A[0],A[1],A[2],B[0],B[1],B[2],C[0],C[1],C[2],C[3]);
	for(i = 0 ; i < 1152 ; ++i){
		A_66 = (A[2] & 2) >> 1;
		A_69 = (A[2] & 16) >> 4;
		A_91 = (A[2] & 67108864) >> 26;
		A_92 = (A[2] & 134217728) >> 27;
		A_93 = (A[2] & 268435456) >> 28;
		Out_A = (A_93 ^ A_66) ^ (A_91 & A_92);
		B_69 = (B[2] & 16) >> 4;
		B_78 = (B[2] & 8192) >> 13;
		B_82 = (B[2] & 131072) >> 17;
		B_83 = (B[2] & 262144) >> 18;
		B_84 = (B[2] & 524288) >> 19;
		Out_B = (B_69 ^ B_84) ^ (B_83 & B_82);
		C_66 = (C[2] & 2) >> 1;
		C_87 = (C[2] & 4194304) >> 22;
		C_109 = (C[3] & 4096) >> 12;
		C_110 = (C[3] & 8192) >> 13;
		C_111 = (C[3] & 16384) >> 14;
		Out_C = (C_111 ^ C_66) ^ (C_110 & C_109);
		A[2] = (A[2] << 1) | (A[1] >> 31);
		A[1] = (A[1] << 1) | (A[0] >> 31);
		A[0] = (A[0] << 1) | (Out_C ^ A_69);
		B[2] = (B[2] << 1) | (B[1] >> 31);
		B[1] = (B[1] << 1) | (B[0] >> 31);
		B[0] = (B[0] << 1) | (Out_A ^ B_78);
		C[3] = (C[3] << 1) | (C[2] >> 31);
		C[2] = (C[2] << 1) | (C[1] >> 31);
		C[1] = (C[1] << 1) | (C[0] >> 31);
		C[0] = (C[0] << 1) | (Out_B ^ C_87);
	}
//	printf("%u %u %u\n%u %u %u\n%u %u %u %u\n",A[0],A[1],A[2],B[0],B[1],B[2],C[0],C[1],C[2],C[3]);
}

char getstream(){
	char res = 0;
	char i = 0;
	for(i = 0 ; i < 8 ; ++i){
		A_66 = (A[2] & 2) >> 1;
		A_69 = (A[2] & 16) >> 4;
		A_91 = (A[2] & 67108864) >> 26;
		A_92 = (A[2] & 134217728) >> 27;
		A_93 = (A[2] & 268435456) >> 28;
		Out_A = (A_93 ^ A_66) ^ (A_91 & A_92);
		B_69 = (B[2] & 16) >> 4;
		B_78 = (B[2] & 8192) >> 13;
		B_82 = (B[2] & 131072) >> 17;
		B_83 = (B[2] & 262144) >> 18;
		B_84 = (B[2] & 524288) >> 19;
		Out_B = (B_69 ^ B_84) ^ (B_83 & B_82);
		C_66 = (C[2] & 2) >> 1;
		C_87 = (C[2] & 4194304) >> 22;
		C_109 = (C[3] & 4096) >> 12;
		C_110 = (C[3] & 8192) >> 13;
		C_111 = (C[3] & 16384) >> 14;
		Out_C = (C_111 ^ C_66) ^ (C_110 & C_109);
		A[2] = (A[2] << 1) | (A[1] >> 31);
		A[1] = (A[1] << 1) | (A[0] >> 31);
		A[0] = (A[0] << 1) | (Out_C ^ A_69);
		B[2] = (B[2] << 1) | (B[1] >> 31);
		B[1] = (B[1] << 1) | (B[0] >> 31);
		B[0] = (B[0] << 1) | (Out_A ^ B_78);
		C[3] = (C[3] << 1) | (C[2] >> 31);
		C[2] = (C[2] << 1) | (C[1] >> 31);
		C[1] = (C[1] << 1) | (C[0] >> 31);
		C[0] = (C[0] << 1) | (Out_B ^ C_87);
		res = (res << 1) | ((Out_A ^ Out_B) ^ Out_C);
	}
	return res;
}

void encode(){
	char c,s;
	FILE * f = fopen("ptt5","r"), * f2 = fopen("ciphertext.txt","w");
	if(f == NULL || f2 == NULL){
		printf("Cant open file!");
		return;
	}
	while(!feof(f)){
		c = fgetc(f);
		s = getstream();
		fprintf(f2 , "%c" , (c^s) & 0xff);
	}
	fclose(f);
}
	 
int main(){
	char choice[1];
	get_key();
	get_iv();
	Initialize();
//	printf("Run key_iv_gen.py to generate new key and iv!\n");
	encode();
	return 0;
}
